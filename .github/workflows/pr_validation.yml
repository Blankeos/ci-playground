name: Check 'Stack' Pull Request Format

on:
  pull_request:
    types: 
      - opened
      - synchronize

jobs:
  check-format:
    name: Validate Stack PR
    
    # Only run if the PR branch starts with `stack/` 
    if: startsWith(github.head_ref, 'stack/')

    runs-on: ubuntu-latest  # can also change to: windows-latest || macos-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      - name: Get all changed files
        id: changed-files
        uses: tj-actions/changed-files@v40

      - name: List all changed files
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "$file was changed"
          done

      - name: Fail if unexpected files were changed
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ ! "$file" =~ ^(stacks/[^/]*/index.test.ts|stacks/[^/]*/index.ts|stacks/[^/]*/index.test.txt|.github.workflows/pr_validation.yml)$ ]]; then
              echo "ðŸ˜¡ File '$file' was changed. This is not allowed in a stack Pull Request."
              echo ""
              echo "You're only allowed to change the following:"
              echo "  - stacks/*/index.ts"
              echo "  - stacks/*/index.test.ts"
              echo "  - stacks/*/index.test.txt"
              exit 1
            fi
          done

      - name: Fail if more than one (1) stack was made
        run: |
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          file_counts=()

          for file in "${files[@]}"; do
            base_name=$(basename "$file")
            if [[ -n "${file_counts["$base_name"]}" ]]; then
              ((file_counts["$base_name"]++))
            else
              file_counts["$base_name"]=1
            fi
          done

          for file in "${!file_counts[@]}"; do
            count=${file_counts["$file"]}
            if ((count > 1)); then
              echo "ðŸ˜¡ More than one file of type '$file' was changed. You should only make 1 stack per Pull Request."
              exit 1
            fi
          done